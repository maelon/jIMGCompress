!function(i,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.jimgcompress=e():i.jimgcompress=e()}("undefined"!=typeof self?self:this,function(){return function(i){function e(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return i[r].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var t={};return e.m=i,e.c=t,e.d=function(i,t,r){e.o(i,t)||Object.defineProperty(i,t,{configurable:!1,enumerable:!0,get:r})},e.n=function(i){var t=i&&i.__esModule?function(){return i.default}:function(){return i};return e.d(t,"a",t),t},e.o=function(i,e){return Object.prototype.hasOwnProperty.call(i,e)},e.p="",e(e.s=0)}([function(i,e,t){"use strict";function r(i,e){if(!(i instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function i(i,e){for(var t=0;t<e.length;t++){var r=e[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(i,r.key,r)}}return function(e,t,r){return t&&i(e.prototype,t),r&&i(e,r),e}}(),n=function(){function i(){r(this,i),this._option={width:600,quality:.9},this._fileName="",this._fileType="",this._fileSize=0,this._width=0,this._height=0,this._originFileSize=0,this._originWidth=0,this._originHeight=0,this._blob=null,this._dataURL="",this._originDataURL="",this._fileTypeEnum={"ffd8ffe*********":"image/jpeg","89504e470d0a1a0a":"image/png","474946**********":"image/gif","424d************":"image/bmp"},this._fileExtEnum={"image/jpeg":"jpg","image/png":"png","image/gif":"gif","image/bmp":"bmp"}}return o(i,[{key:"compress",value:function(i,e,t,r){var o=this;if(i)if(i instanceof File)if(i.size){Object.assign(this._option,e),(this._option.quality>1||this._option.quality<0)&&(this._option.quality=.9),this._option.limitSize<1024&&(this._option.limitSize=1024);var n=function(){var e=new FileReader;e.addEventListener("load",function(i){o._originDataURL=i.target.result,t({fileName:o._fileName,fileType:o._fileType,fileSize:o._fileSize,width:o._width,height:o._height,originFileSize:o._originFileSize,originWidth:o._originWidth,originHeight:o._originHeight,blob:o._blob,dataURL:o._dataURL,originDataURL:o._originDataURL})}),e.readAsDataURL(i)};this._checkFileType(i,function(e,t){o._fileType=e,o._fileName=t,o._originFileSize=i.size;var a=new Blob([i],{type:e});o._compress(a,n,r)},function(i){o._throwError(i,r)})}else{var a={type:"emptyfile",msg:"file error: file content is empty"};this._throwError(a,r)}else{var s={type:"notfile",msg:"argument type error: not a File type"};this._throwError(s,r)}else{var l={type:"nofile",msg:"argument error: file is null"};this._throwError(l,r)}}},{key:"addFileHeaderEnum",value:function(i,e,t){"string"==typeof i&&"string"==typeof e&&/image\/\w+/.test(e)&&"string"==typeof t&&(this._fileTypeEnum[i]=e,this._fileExtEnum[e]=t)}},{key:"_checkFileType",value:function(i,e,t){var r=this;if(""!==i.type)e(i.type,i.name);else try{var o=new FileReader;o.addEventListener("load",function(o){var n=o.target.result;try{!function(){for(var o=new DataView(n,0),a=[],s=0;s<8;s++)!function(i){a.push(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"0"+o.getUint8(i).toString(16);return e.substring(e.length-2)}())}(s);var l=a.join(""),h="";for(var g in r._fileTypeEnum){if(new RegExp("^"+g.replace(/\*/gi,"\\w")+"$","ig").test(l)){h=r._fileTypeEnum[g];break}}if(h)e(h,i.name+"."+r._fileExtEnum[h]);else{var f={type:"badfiletype",msg:"file type error: cannot analysis file type"};r._throwError(f,t)}}()}catch(o){var a={type:"apierror",msg:"api error: not support DataView api"};r._throwError(a,t)}}),o.readAsArrayBuffer(i)}catch(i){var n={type:"apierror",msg:"api error: not support FileReader api"};this._throwError(n,t)}}},{key:"_compress",value:function(i,e,t){var r=this;try{this._originFileSize=i.size;var o=document.createElement("img"),n=URL.createObjectURL(i);o.addEventListener("load",function(i){URL.revokeObjectURL(n);var t=i.target;r._originWidth=t.naturalWidth,r._originHeight=t.naturalHeight;var o=void 0,a=void 0,s=r._option.width,l=r._option.height;void 0===s||"auto"===s||void 0!==l&&"auto"!==l?void 0!==l||"auto"===l||void 0!==s&&"auto"!==s?void 0!==s&&"auto"!==s&&void 0!==l&&"auto"!==l?(o=parseInt(s),a=parseInt(l),o*r._originHeight/r._originWidth>a?(o=Math.floor(a*r._originWidth/r._originHeight))>r._originWidth&&(o=r._originWidth,a=r._originHeight):(a=Math.floor(o*r._originHeight/r._originWidth))>r._originHeight&&(o=r._originWidth,a=r._originHeight)):(o=r._originWidth,a=r._originHeight):(a=parseInt(l),r._originHeight<a&&(a=r._originHeight),o=Math.floor(a*r._originWidth/r._originHeight)):(o=parseInt(s),r._originWidth<o&&(o=r._originWidth),a=Math.floor(o*r._originHeight/r._originWidth));for(var h=r._compressByCanvas(t,o,a,r._option.quality),g=r._dataURL2Blob(h);g.size>r._option.limitSize;)o=Math.floor(.8*o),a=Math.floor(.8*a),h=r._compressByCanvas(t,o,a,r._option.quality),g=r._dataURL2Blob(h);r._fileSize=g.size,r._width=o,r._height=a,r._blob=g,r._dataURL=h,e("finish")}),o.src=n}catch(i){var a={type:"apierror",msg:"api error: not support canvas or URL api"};this._throwError(a,t)}}},{key:"_compressByCanvas",value:function(i,e,t,r){var o=document.createElement("canvas");o.width=e,o.height=t;var n=o.getContext("2d");return n.fillStyle="#FFF",n.fillRect(0,0,o.width,o.height),n.drawImage(i,0,0,o.width,o.height),o.toDataURL("image/jpeg",r)}},{key:"_dataURL2Blob",value:function(i){try{for(var e=i.split(","),t=e[0].match(/:(.*?);/)[1],r=atob(e[1]),o=r.length,n=new Uint8Array(o);o--;)n[o]=r.charCodeAt(o);return new Blob([n],{type:t})}catch(i){var a={type:"apierror",msg:"api error: not support atob or Unit8Array api"};this._throwError(a,errorback)}}},{key:"_throwError",value:function(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1];if(!e||"function"!=typeof e)throw new Error(i.msg);e(i)}}]),i}();e.default=new n}])});